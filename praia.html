<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pedido de Namoro</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Roteiro Especial üíñ</h1>
      <div id="status" class="status">Aguardando permiss√£o de localiza√ß√£o‚Ä¶</div>
      <div id="hint" class="status">Dica: O lugar onde voc√™ me ofereceu uma bala.</div>
      <button id="btnStart">Ativar verifica√ß√£o</button>
      <div id="actions" class="hidden">
        <button id="btnArrived" class="hidden">Cheguei ao Local</button>
        <div id="poem" class="hidden" style="margin-top:16px;">
            <p>Um beijo ficou na lembran√ßa</p>
            <p>Deixando um desejo</p>
            <p>Nem sei o que dizer</p>
            <p>E agora perdi a cabe√ßa</p>
            <p>E a hora n√£o passa</p>
            <p>Em todos os lugares s√≥ vejo voc√™</p>
        </div>
        <button id="btnNext" class="hidden">Ir para pr√≥xima dica</button>
      </div>
      
    </div>
  </div>
  <script>
    const point = {lat:-22.391939, lng:-41.783559, radius:50, requiredAccuracy:200};
    //const point = {lat:-22.356046, lng:-41.769842, radius:50, requiredAccuracy:200};
    const statusEl = document.getElementById('status');
    const hintEl = document.getElementById('hint');
    const btnStart = document.getElementById('btnStart');
    const btnArrived = document.getElementById('btnArrived');
    const btnNext = document.getElementById('btnNext');
    const actions = document.getElementById('actions');
    const poemEl = document.getElementById('poem');

    let arrived = false;   // Usu√°rio entrou no raio do ponto
    let poemShown = false; // Usu√°rio clicou em ‚ÄúCheguei ao Local‚Äù

    function haversine(lat1, lon1, lat2, lon2){
      const R = 6371e3;
      const toRad = v => v * Math.PI/180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c;
    }

    function updatePosition(position){
        if(!position || !position.coords) return;
        const {latitude, longitude, accuracy} = position.coords;
        if(typeof latitude !== 'number' || typeof longitude !== 'number') return;

        const dist = haversine(latitude, longitude, point.lat, point.lng);

        if(accuracy > point.requiredAccuracy){
            statusEl.textContent = `Precis√£o insuficiente (¬±${Math.round(accuracy)}m). Aguardando sinal melhor‚Ä¶`;
            return;
        }

        if(dist <= point.radius){
            statusEl.textContent = `Voc√™ chegou ao destino!`;

            if(!arrived){ // Executa apenas uma vez
                hintEl.classList.add('hidden'); // oculta dica inicial
                btnStart.classList.add('hidden'); // oculta bot√£o iniciar
                btnArrived.classList.remove('hidden'); // exibe bot√£o Cheguei ao Local
                arrived = true;
            }

        } else {
            statusEl.textContent = `Dist√¢ncia aproximada at√© o local: ${dist.toFixed(1)} m`;
        }
    }

    function startWatch(){
      if(!navigator.geolocation){
        statusEl.textContent = 'Geolocaliza√ß√£o n√£o suportada neste navegador.';
        return;
      }
      btnStart.disabled = true;
      actions.classList.remove('hidden');
      navigator.geolocation.watchPosition(updatePosition, err => {
        statusEl.textContent = 'Erro ao obter localiza√ß√£o.';
      }, {enableHighAccuracy:true, maximumAge:1000, timeout:15000});
    }

    btnStart.addEventListener('click', startWatch);

    btnArrived.addEventListener('click', ()=>{
        if(!poemShown){
            poemEl.classList.remove('hidden');
            btnNext.classList.remove('hidden');
            btnArrived.classList.add('hidden');
            statusEl.classList.add('hidden');
            poemShown = true;
        }
    });

    btnNext.addEventListener('click', ()=>{
      window.location.href = 'mirante.html';
    });
  </script>
</body>
</html>
