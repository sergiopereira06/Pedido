<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pedido de Namoro</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Roteiro Especial ğŸ’–</h1>
      <div id="status" class="status">Aguardando permissÃ£o de localizaÃ§Ã£oâ€¦</div>
      <div id="hint" class="status">Dica: O lugar onde vocÃª me ofereceu uma bala.</div>
      <button id="btnStart">Ativar verificaÃ§Ã£o</button>
      <div id="actions" class="hidden">
        <button id="btnArrived" class="hidden">Cheguei ao Local</button>
        <div id="poem" class="hidden" style="margin-top:16px;">
            <p>Naquele dia na praia, sentados, apreciando o mar, tudo parecia perfeito.</p>
            <p>O vento, o som das ondas e o cÃ©u formavam o cenÃ¡rio perfeito para nÃ³s dois.</p>
            <p>EntÃ£o, vocÃª me ofereceu uma bala Halls e, provocando, colocou na bocaâ€¦ e foi ali, naquele instante, que aconteceu nosso <strong>primeiro beijo</strong>.</p>
            <p>Ficamos nos beijando, nos curtindo, com o mundo inteiro desaparecendo ao nosso redor.</p>
            <br><br><br>
            <p><em>ğŸ¶ğŸµ<br> 
            Um beijo ficou na lembranÃ§a<br>
            Deixando um desejo<br>
            Nem sei o que dizer<br>
            E agora perdi a cabeÃ§a<br>
            E a hora nÃ£o passa<br>
            Em todos os lugares sÃ³ vejo vocÃª<br>
            ğŸµğŸ¶</em></p>

        </div>
      </div>
      
    </div>
  </div>
  <script>
    const point = {lat:-22.356046, lng:-41.769842, radius:50, requiredAccuracy:200};
    const statusEl = document.getElementById('status');
    const hintEl = document.getElementById('hint');
    const btnStart = document.getElementById('btnStart');
    const btnArrived = document.getElementById('btnArrived');
    const actions = document.getElementById('actions');
    const poemEl = document.getElementById('poem');

    let arrived = false;   // UsuÃ¡rio entrou no raio do ponto
    let poemShown = false; // UsuÃ¡rio clicou em â€œCheguei ao Localâ€

    function haversine(lat1, lon1, lat2, lon2){
      const R = 6371e3;
      const toRad = v => v * Math.PI/180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c;
    }

    function updatePosition(position){
        if(!position || !position.coords) return;
        const {latitude, longitude, accuracy} = position.coords;
        if(typeof latitude !== 'number' || typeof longitude !== 'number') return;

        const dist = haversine(latitude, longitude, point.lat, point.lng);

        if(accuracy > point.requiredAccuracy){
            statusEl.textContent = `PrecisÃ£o insuficiente (Â±${Math.round(accuracy)}m). Aguardando sinal melhorâ€¦`;
            return;
        }

        if(dist <= point.radius){
            statusEl.textContent = `VocÃª chegou ao destino!`;

            if(!arrived){ // Executa apenas uma vez
                hintEl.classList.add('hidden'); // oculta dica inicial
                btnStart.classList.add('hidden'); // oculta botÃ£o iniciar
                btnArrived.classList.remove('hidden'); // exibe botÃ£o Cheguei ao Local
                arrived = true;
            }

        } else {
            statusEl.textContent = `DistÃ¢ncia aproximada atÃ© o local: ${dist.toFixed(1)} m`;
        }
    }

    function startWatch(){
      if(!navigator.geolocation){
        statusEl.textContent = 'GeolocalizaÃ§Ã£o nÃ£o suportada neste navegador.';
        return;
      }
      btnStart.disabled = true;
      actions.classList.remove('hidden');
      navigator.geolocation.watchPosition(updatePosition, err => {
        statusEl.textContent = 'Erro ao obter localizaÃ§Ã£o.';
      }, {enableHighAccuracy:true, maximumAge:1000, timeout:15000});
    }

    btnStart.addEventListener('click', startWatch);

    btnArrived.addEventListener('click', ()=>{
        if(!poemShown){
            poemEl.classList.remove('hidden');
            btnArrived.classList.add('hidden');
            statusEl.classList.add('hidden');
            poemShown = true;
        }
    });

  </script>
</body>
</html>
